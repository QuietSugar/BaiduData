<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8"/>
    <title>用百度API获取全国公交数据</title>
    <link rel="stylesheet" type="text/css" href="http://cdn.bootcss.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <style type="text/css">

        .luter_titlebar {
            z-index: 20000;
            position: absolute;
            top: 1px;
            right: 20%;
            left: 20%;
            width: auto;
            height: 30px;
            background: rgba(0, 0, 0, 0.00);
            text-align: center;
            color: #000;
        }

        .luter_titlebar span {
            font-size: 24px;
            color: #000;
        }

        .luter_sidebar {
            z-index: 20000;
            position: absolute;
            top: 70px;
            left: 0px;
            width: 20%;
            height: 10%;
            background: rgba(0, 0, 0, 0.10);
            text-align: center;
            color: #FFFFFF;
            /*overflow: auto;*/
        }
    </style>
</head>
<body>
<div class="luter_titlebar">
    <span>用百度API获取全国公交数据</span>
</div>


<div class="container-fluid">
    <div class="row well" style="margin-top:30px">
        <div class="col-md-3">
            <input class="form-control" type="text" value="北京" id="cityName"/>

            <div class="input-group">
                <span class="input-group-addon">公交线路:</span>
                <input class="form-control" type="text" value="1" id="busId"/>
             <span class="input-group-btn">
                  <button class="btn btn-default" id="btn-search" type="button">
                      <i class="glyphicon glyphicon-search"></i>获取
                  </button>
               </span>
            </div>
        </div>
        <div class="col-md-7">
        <span class="text-success">
            这个页面展示如何从百度获取全国公交数据，一般城市公交都是从1路到1000路，不会有更多。
            如果要抓取数据，可以写一个循环，比如：for (var i=1;i<100;i++){//这里循环获取每一路}
            获取到数据后，ajax提交后台保存到数据库即可，保存的时候用线路名称判断一下是否已经存在
            如果存在就不管或者更新，不存在的就是新线路。

        </span>
        </div>
    </div>
    <div class="row">
        <div id="buslines"></div>
    </div>
</div>
<div>
    <form action="BaiduDataServlet" method="post">
        <p>First name: <input type="text" name="fname"/></p>
        <p>Last name: <input type="text" name="lname"/></p>
        <input type="submit" value="Submit"/>
    </form>
</div>
<div id="results" style="display: none;" class="col-md-1"></div>
<!--1IqchvWD47X4jXVjDi6iwvgt5W5fGTcH-->
<script src="http://api.map.baidu.com/api?v=1.3" type="text/javascript"></script>
<script src="http://apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js" type="text/javascript"></script>
<script type="text/javascript" src="http://cdn.bootcss.com/jquery/1.12.0/jquery.min.js"></script>
<script type="text/javascript" src="http://cdn.bootcss.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script type="text/javascript">
    document.getElementById('btn-search').onclick = function () {
        var cityName = $("#cityName").val();
        var busIds = $("#busId").val();
        var busline = new BMap.BusLineSearch("北京", {
            renderOptions: {
                panel: "results"
            },
            onGetBusListComplete: function (result) {
                if (result) {
                    var thedata = result._listItems;
                    if (thedata.length > 0) {
                        for (var a = 0; a < thedata.length; a++) {
                            //循环所有的线路列表
                            busline.getBusLine(result.getBusListItem(a));
                        }
                    } else {
                        console.log('没获取到站点信息');
                    }
                } else {
                    console.log('没获取到站点信息');
                }

            },
            onGetBusLineComplete: function (result) {
                $('#buslines').append('<br><br><font color="red">*********找到线路:</font>[' + result.name + ']<br><br>')
                $('#buslines').append('<br><font color="blue">-------线路的经纬度:</font><br>')
                console.log(result);
                var lines = result._polyline.points;//这个是线路数据
                for (var i = 0; i < lines.length; i++) {
                    $('#buslines').append('[' + lines[i].lng + ',' + lines[i].lat + '],')
                }
                var stations = result._stations;//这个是这条线路的站点信息
                $('#buslines').append('<br><font color="blue">-------站点的经纬度:</font><br>')
                for (var j = 0; j < stations.length; j++) {
                    $('#buslines').append('"' + stations[j].name + '":[' + stations[j].position.lng + ',' + stations[j].position.lat + '],')
                }
                var postData = {
                    line_name: result.name,//线路名称
                    line: lines,//线路的线坐标
                    company: result.company,//线路运营公司
                    stations: stations,//这条线路的站点和坐标
                    startTime: result.startTime,//首班车
                    endTime: result.endTime//末班车

                };
                console.log(postData);
                //在这里用ajax把postData提交给后台，保存数据库。根据线路名称判断是否已经存了，没存再存，存了就别存或者更新。
                //至于存储格式，就按你们需要的自定义即可，这个办法，可以确保随时拿到百度公交的全国所有数据。
                $.ajax({
                    type: "POST",
                    url: "BaiduDataServlet",
                    data: {
                        line_name: postData.line_name,
                        line_value: JSON.stringify(postData)
                    },
//                    contentType: "application/json;charset=utf-8",
                    success: function (result) {
                    }

                });

            }, onMarkersSet: function (result) {
            }
        });

        if ("all" == busIds) {
            for (var k = 0; k < 1000; k++) {
                busline.getBusList(k);
            }

        } else {
            var array = busIds.split(",");
            for (var z = 0; z < array.length; z++) {
                console.log(array[z]);
                busline.getBusList(array[z].toString());
            }

//            busline.getBusList("385路");
//            busline.getBusList("476路");
//            busline.getBusList("845路");
//            busline.getBusList("828路");
//            busline.getBusList("326路");
//            busline.getBusList("通12");
//            busline.getBusList("362路");
//            busline.getBusList("21路");
//            busline.getBusList("通9");
//            busline.getBusList("414路");
//            busline.getBusList("56路");
//            busline.getBusList("805路");
//            busline.getBusList("通勤班车（里二泗总站-地铁九棵树站）");
//            busline.getBusList("通2");
//            busline.getBusList("通11");
//            busline.getBusList("503路");
//            busline.getBusList("通1");
//            busline.getBusList("815路快");
//            busline.getBusList("809路");
//            busline.getBusList("943路");
//            busline.getBusList("938路");
//            busline.getBusList("通35");
//            busline.getBusList("803路");
//            busline.getBusList("通29");
//            busline.getBusList("926路");
//            busline.getBusList("364路");
//            busline.getBusList("通勤班车（大地站-通州北苑路口西）");
//            busline.getBusList("463路");
//            busline.getBusList("810路快");
//            busline.getBusList("通勤班车（柴厂屯-地铁通州北苑路口西）");
//            busline.getBusList("通15");
//            busline.getBusList("324路");
//            busline.getBusList("306路");
//            busline.getBusList("461路");
//            busline.getBusList("460路");
//            busline.getBusList("通27");
//            busline.getBusList("城际通勤班车（安平香汐花园-郎家园）");
//            busline.getBusList("通6专");
//            busline.getBusList("顺18区 ");
//            busline.getBusList("29路");
//            busline.getBusList("440路");
//            busline.getBusList("818路快");
//            busline.getBusList("804路");
//            busline.getBusList("80路");
//            busline.getBusList("942路快");
//            busline.getBusList("805路快");
//            busline.getBusList("通20");
//            busline.getBusList("436路");
//            busline.getBusList("847路");
//            busline.getBusList("499快");
        }
    }


</script>
</body>

</html>
